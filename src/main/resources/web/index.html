<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Sharing App - Web UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fb;
            margin: 0;
            color: #24292f;
            transition: background 0.3s, color 0.3s;
        }
        .dark-mode {
            background: #0d1117;
            color: #c9d1d9;
        }
        .wrapper {
            max-width: 900px;
            margin: 20px auto;
            background: #fff;
            padding: 20px 24px 26px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .dark-mode .wrapper {
            background: #161b22;
        }
        h1 {
            margin: 0 0 16px;
            color: #1f6feb;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label {
            display: block;
            margin-top: 14px;
            font-weight: 600;
            font-size: 14px;
        }
        input, select {
            width: 100%;
            padding: 9px 10px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #d0d7de;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            margin-top: 20px;
            padding: 11px 22px;
            background: #1f6feb;
            color: #fff;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { background: #144a9b; }
        .small { font-size: 12px; color: #57606a; }
        .ip-box {
            padding: 10px 12px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        #status {
            margin-top: 10px;
            min-height: 16px;
        }
        #status.ok    { color: #137333; }
        #status.warn  { color: #b36b00; }
        #status.error { color: #b3261e; }
        .progress-container {
            margin-top: 10px;
            background: #e1e4e8;
            border-radius: 6px;
            height: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: #1f6feb;
            transition: width 0.3s;
        }
        .dark-mode .progress-container {
            background: #30363d;
        }
        .dark-mode .progress-bar {
            background: #58a6ff;
        }
        .help-popup {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            border: 1px solid #d0d7de;
            padding: 16px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 999;
        }
        .dark-mode .help-popup {
            background: #161b22;
            color: #c9d1d9;
            border-color: #30363d;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <h1><span>üìÅ</span> <span>File Sharing App - Web UI</span></h1>

    <div class="ip-box">
        <div>Your IP: <strong id="userIP">localhost</strong></div>
        <div class="small">Share this IP or URL with your partner.</div>
    </div>

    <form id="transferForm">
        <label for="name">Your Name</label>
        <input id="name" type="text" placeholder="Enter your name"/>

        <label for="role">Role</label>
        <select id="role">
            <option value="Sender">Sender</option>
            <option value="Receiver">Receiver</option>
        </select>

        <label for="method">Transfer Method</label>
        <select id="method">
            <option value="HTTP">HTTP (LAN)</option>
            <option value="ZeroTier">ZeroTier (P2P)</option>
            <option value="S3">AWS S3 (Cloud)</option>
        </select>

        <label for="aesKey">AES Key (Optional)</label>
        <input id="aesKey" type="password" placeholder="Enter AES key for encryption"/>

        <!-- Sender file upload box (hide for Receiver) -->
        <div id="senderBox">
            <label for="file" id="fileLabel">File(s)</label>
            <input id="file" type="file" multiple/>
        </div>

        <label for="target">Target IP / URL / Bucket</label>
        <input id="target" type="text" placeholder="Receiver IP or Bucket"/>

        <label for="port">Port</label>
        <input id="port" type="text" value="8080"/>

        <button id="startBtn" type="submit"><span>üöÄ</span> <span>Start</span></button>
        <button type="button" id="helpBtn">‚ùì Help</button>
        <button type="button" id="darkModeBtn">üåô Dark Mode</button>
    </form>

    <div id="status" class="small" aria-live="polite"></div>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div id="speedInfo" class="small"></div>
</div>

<div class="help-popup" id="helpPopup">
    <strong>Baby-English Guide:</strong>
    <ul>
        <li>Pick your role: Sender or Receiver.</li>
        <li>Choose method: HTTP, ZeroTier, or S3.</li>
        <li>Sender: Select file(s) and enter target IP or bucket.</li>
        <li>Receiver: Wait for file to come.</li>
        <li>AES key is optional for encryption.</li>
    </ul>
    <button id="closeHelp">Close</button>
</div>

<script>
    // ------------------ UI MODE SWITCH ------------------
    function updateUI() {
        const role = document.getElementById('role').value;

        if (role === "Receiver") {
            document.getElementById("senderBox").style.display = "none";
        } else {
            document.getElementById("senderBox").style.display = "block";
        }
    }

    document.getElementById("role").addEventListener("change", updateUI);
    document.getElementById("method").addEventListener("change", updateUI);
    updateUI(); // initial load


    // ------------------ Dark Mode ------------------
    document.getElementById('darkModeBtn').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
    });

    // ------------------ Help Popup ------------------
    const helpPopup = document.getElementById('helpPopup');
    document.getElementById('helpBtn').addEventListener('click', () => {
        helpPopup.style.display = 'block';
    });
    document.getElementById('closeHelp').addEventListener('click', () => {
        helpPopup.style.display = 'none';
    });

    // ------------------ IP detection ------------------
    async function detectLocalIP() {
        const ipEl = document.getElementById('userIP');
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            ipEl.textContent = data.ip || location.hostname;
        } catch {
            ipEl.textContent = location.hostname || 'localhost';
        }
    }
    detectLocalIP();


    // ------------------ Status & Progress ------------------
    function setStatus(text, level) {
        const el = document.getElementById('status');
        el.textContent = text || '';
        el.className = 'small';
        if (level) el.classList.add(level);
    }

    function updateProgress(percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }


    // ------------------ HTTP UPLOAD (Sender) ------------------
    async function uploadHttpFiles(files, port) {
        const transferId = 'browser-' + Date.now();
        const chunkSize = 512 * 1024;
        let totalBytes = Array.from(files).reduce((s, f) => s + f.size, 0);
        let uploadedBytes = 0;
        let startTime = Date.now();

        for (const file of files) {
            let offset = 0;
            let chunkIndex = 0;

            while (offset < file.size) {
                const end = Math.min(offset + chunkSize, file.size);
                const blob = file.slice(offset, end);
                const bytes = new Uint8Array(await blob.arrayBuffer());

                const params = new URLSearchParams({
                    transferId,
                    fileName: file.name,
                    chunkIndex,
                    totalBytes: file.size
                });

                const res = await fetch('/upload?' + params.toString(), {
                    method: 'POST',
                    body: bytes
                });

                if (!res.ok) {
                    setStatus('‚ùå Upload stopped at chunk ' + chunkIndex, 'error');
                    return;
                }

                offset = end;
                chunkIndex++;
                uploadedBytes += bytes.length;

                const pct = Math.round((uploadedBytes / totalBytes) * 100);
                updateProgress(pct);

                const elapsed = (Date.now() - startTime) / 1000;
                const speed = (uploadedBytes / (1024 * 1024) / elapsed).toFixed(2);
                const eta = ((totalBytes - uploadedBytes) / (uploadedBytes / elapsed)).toFixed(1);

                document.getElementById('speedInfo').textContent = `Speed: ${speed} MB/s | ETA: ${eta}s`;
                setStatus(`üì§ Uploading‚Ä¶ ${pct}%`, 'ok');
            }
        }

        setStatus('‚úÖ Upload finished.', 'ok');
    }


    // ------------------ HTTP RECEIVER (Download) ------------------
    async function startHttpReceiver(port) {
        setStatus('üì• Waiting for sender‚Ä¶', 'ok');

        const pollInterval = setInterval(async () => {
            try {
                const res = await fetch(`/download?port=${port}`);

                if (res.status === 204) return; // no file yet

                if (!res.ok) {
                    setStatus('‚ùå Receiver error during download.', 'error');
                    clearInterval(pollInterval);
                    return;
                }

                // File is ready
                const blob = await res.blob();
                const fileName = res.headers.get("X-Filename") || "received_file";

                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();

                updateProgress(100);
                setStatus(`‚úÖ File received: ${fileName}`, 'ok');
                clearInterval(pollInterval);

            } catch (err) {
                setStatus('‚ùå Receiver crashed: ' + err, 'error');
                clearInterval(pollInterval);
            }
        }, 2000);
    }


    // ------------------ SUBMIT HANDLER ------------------
    document.getElementById('transferForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const role = document.getElementById('role').value;
        const method = document.getElementById('method').value;
        const files = document.getElementById('file').files;
        const port = document.getElementById('port').value.trim() || '8080';

        if (!document.getElementById('name').value.trim()) {
            setStatus('Please tell me your name üòä', 'warn');
            return;
        }

        if (role === 'Sender' && method === 'HTTP') {
            if (files.length === 0) {
                setStatus('You did not pick any file.', 'error');
                return;
            }
            uploadHttpFiles(files, port);
        }

        if (role === 'Receiver' && method === 'HTTP') {
            startHttpReceiver(port);
        }
    });
</script>
</body>
</html>
