<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Sharing App</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f7fb; margin: 0; }
        .wrapper { max-width: 800px; margin: 20px auto; background: #fff; padding: 20px;
          border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1 { margin-top: 0; color: #1f6feb; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 5px; border: 1px solid #ccc; }
        button { margin-top: 15px; padding: 10px 16px; background: #1f6feb; color: #fff;
          border: none; border-radius: 6px; cursor: pointer; font-size: 15px; }
        button:hover { background: #144a9b; }
        .small { font-size: 12px; color: #666; }
        .ip-box { padding: 8px; background: #f0f4ff; border-radius: 6px; margin-bottom: 10px; }
    </style>
</head>
<body>
<div class="wrapper">
    <h1 tabindex="0">üìÅ File Sharing App - Web UI</h1>

    <div class="ip-box">
        <div>Your IP (share this with your partner): <span id="userIP">localhost</span></div>
        <div class="small">If you're on same Wi-Fi, use this. For remote, use ZeroTier.</div>
    </div>

    <!-- Wrap form so we can validate on submit -->
    <form id="transferForm">
        <label for="name">Your Name</label>
        <input id="name" type="text" placeholder="Enter your name"/>

        <label for="role">Role</label>
        <select id="role">
            <option value="Sender">Sender</option>
            <option value="Receiver">Receiver</option>
        </select>

        <label for="method">Transfer Method</label>
        <select id="method">
            <option value="HTTP">HTTP (Simple / LAN)</option>
            <option value="ZeroTier">ZeroTier (Secure P2P)</option>
            <option value="S3">AWS S3 (Cloud)</option>
        </select>

        <!-- This label text is updated dynamically based on Role -->
        <label for="file" id="fileLabel">File (Sender only)</label>
        <input id="file" type="file"/>

        <label for="target">Target IP / URL / Bucket</label>
        <input id="target" type="text" placeholder="192.168.x.x or bucket-name"/>

        <label for="port">Port</label>
        <input id="port" type="text" value="8080"/>

        <button id="startBtn" type="submit">üöÄ Start</button>
    </form>

    <!-- Single status line used by script -->
    <div id="status" class="small" aria-live="polite"></div>
</div>

<script>
    // Best-effort external IP detection for display only
    async function detectLocalIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        document.getElementById('userIP').textContent = data.ip;
      } catch (e) {
        document.getElementById('userIP').textContent = location.hostname || 'localhost';
      }
    }
    window.onload = detectLocalIP;

    // Validation + friendly prompts on Start
    (function () {
      const form     = document.getElementById('transferForm');
      const roleEl   = document.getElementById('role');
      const methodEl = document.getElementById('method');
      const targetEl = document.getElementById('target');
      const nameEl   = document.getElementById('name');
      const fileEl   = document.getElementById('file');
      const statusEl = document.getElementById('status');
      const fileLabel = document.getElementById('fileLabel');

      // --- ROLE-BASED LABEL BEHAVIOR ---
      // When Sender: "File (Sender only)"
      // When Receiver: "Save Location (Receiver only)"
      function updateFileLabel() {
        if (roleEl.value === 'Sender') {
          fileLabel.textContent = 'File (Sender only)';
          fileEl.disabled = false;
        } else {
          fileLabel.textContent = 'Save Location (Receiver only)';
          // Web UI is informational; keep input enabled so layout stays stable.
          // (Desktop app actually handles the save path.)
        }
      }
      updateFileLabel();
      roleEl.addEventListener('change', updateFileLabel);

      // --- SUBMIT VALIDATION ---
      form.addEventListener('submit', function (e) {
        statusEl.textContent = '';

        const role   = roleEl.value;
        const method = methodEl.value;
        const target = targetEl.value.trim();

        // 1) Require name
        if (!nameEl.value.trim()) {
          e.preventDefault();
          statusEl.textContent = "Please tell me your name üòä";
          return;
        }

        // 2) Sender must pick a file
        if (role === 'Sender' && !fileEl.files.length) {
          e.preventDefault();
          statusEl.textContent = "You did not pick any file. Please select at least one file.";
          return;
        }

        // 3) Sender + real transport => target required
        const needsTarget =
          role === 'Sender' &&
          (method === 'HTTP' || method === 'ZeroTier' || method === 'S3');

        if (needsTarget && !target) {
          e.preventDefault();
          statusEl.textContent =
            "Please enter the Receiver IP / URL / Bucket before starting üö¶";
          return;
        }

        // 4) Friendly footer AFTER valid input
        if (role === 'Receiver') {
          statusEl.textContent =
            "Hi friend üëã Fill in the details above and click Start when you're ready to receive.";
        } else {
          statusEl.textContent = "Awesome üöÄ Preparing your transfer‚Ä¶";
        }

        // NOTE: This Web UI is a helper / front-end only in v1.0.15.
        // Prevent full page navigation; desktop app handles the real transfer.
        e.preventDefault();
      });
    })();

    // Poll lightweight /prompt updates to show server messages in the UI
setInterval(async () => {
  try {
    const res = await fetch('/prompt');
    const txt = await res.text();
    if (txt && txt !== 'OK') {
      document.getElementById('status').textContent = txt;
    }
  } catch (_) {}
}, 1500);

</script>
</body>
</html>
